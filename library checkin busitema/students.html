<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students - Library Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-8">

    <div class="max-w-6xl mx-auto space-y-8">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Student Management</h1>
                <p class="text-gray-500 mt-1 text-sm">Busitema University Library</p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">Back to
                    Check-in</a>
                <button id="add-student-btn"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition shadow-sm">
                    + Add Student
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <div class="relative w-full max-w-xs">
                <input type="text" id="search-input" placeholder="Search students..."
                    class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>

            <div class="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                <button id="view-table-btn" class="p-2 rounded-md bg-white shadow-sm text-indigo-600 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                </button>
                <button id="view-grid-btn" class="p-2 rounded-md text-gray-500 hover:text-indigo-600 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="min-h-[300px]">
            <!-- Loading State -->
            <div class="flex justify-center items-center h-64 text-gray-400">
                Loading students...
            </div>
        </div>

    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Student</h2>
            <form id="add-student-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="new-student-name" required
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                    <input type="text" id="new-student-id" required
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Card UID</label>
                    <input type="text" id="new-card-uid" required placeholder="Scan card or type UID"
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <div class="flex space-x-3 mt-8">
                    <button type="button" id="cancel-add-btn"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition shadow-lg shadow-indigo-200">
                        Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import {
            getFirestore,
            doc,
            collection,
            setDoc,
            onSnapshot,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDaAXU7EldHegMh8GwKIerawR1JW38yGYI",
            authDomain: "uni-library-checkin.firebaseapp.com",
            projectId: "uni-library-checkin",
            storageBucket: "uni-library-checkin.appspot.com",
            messagingSenderId: "190756010969",
            appId: "1:190756010969:web:0d8a529d2a2adba928b7c8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let students = [];
        let currentView = 'table'; // 'table' or 'grid'
        let searchQuery = '';

        // DOM Elements
        const contentArea = document.getElementById('content-area');
        const viewTableBtn = document.getElementById('view-table-btn');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const searchInput = document.getElementById('search-input');
        const addStudentBtn = document.getElementById('add-student-btn');
        const addStudentModal = document.getElementById('add-student-modal');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const addStudentForm = document.getElementById('add-student-form');

        // Auth
        signInAnonymously(auth).then(() => {
            console.log("Signed in");
            setupStudentsListener();
        }).catch(console.error);

        // Listeners
        function setupStudentsListener() {
            const q = query(collection(db, "students"), orderBy("Name")); // Assuming 'Name' field exists

            onSnapshot(q, (snapshot) => {
                students = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                render();
            });
        }

        // Render Logic
        function render() {
            const filtered = students.filter(s =>
                (s.Name && s.Name.toLowerCase().includes(searchQuery.toLowerCase())) ||
                (s.id && s.id.toLowerCase().includes(searchQuery.toLowerCase())) ||
                (s.cardUid && s.cardUid.toLowerCase().includes(searchQuery.toLowerCase()))
            );

            if (filtered.length === 0) {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <svg class="w-12 h-12 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>No students found</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'table') {
                renderTable(filtered);
            } else {
                renderGrid(filtered);
            }
        }

        function renderTable(data) {
            const rows = data.map(student => {
                const status = student.status || 'out';
                const statusClass = status === 'in'
                    ? 'bg-green-100 text-green-800'
                    : 'bg-gray-100 text-gray-800';

                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.Name || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${student.cardUid || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass} uppercase tracking-wide">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Card UID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderGrid(data) {
            const cards = data.map(student => {
                const status = student.status || 'out';
                const isOnline = status === 'in';

                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4">
                            <div class="w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-300'} ring-4 ring-white"></div>
                        </div>
                        
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold text-lg">
                                ${(student.Name || '?').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 truncate pr-6">${student.Name || 'Unknown'}</h3>
                                <p class="text-sm text-gray-500">${student.id}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Card UID</span>
                                <span class="font-mono text-gray-700">${student.cardUid || '-'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Status</span>
                                <span class="font-medium ${isOnline ? 'text-green-600' : 'text-gray-500'} uppercase text-xs tracking-wider">
                                    ${status}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            contentArea.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${cards}
                </div>
            `;
        }

        // Event Handlers
        viewTableBtn.addEventListener('click', () => {
            currentView = 'table';
            viewTableBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            viewTableBtn.classList.remove('text-gray-500');
            viewGridBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            viewGridBtn.classList.add('text-gray-500');
            render();
        });

        viewGridBtn.addEventListener('click', () => {
            currentView = 'grid';
            viewGridBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            viewGridBtn.classList.remove('text-gray-500');
            viewTableBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            viewTableBtn.classList.add('text-gray-500');
            render();
        });

        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            render();
        });

        // Modal Logic
        addStudentBtn.addEventListener('click', () => {
            addStudentModal.classList.remove('hidden');
            addStudentModal.classList.add('flex');
        });

        function closeModal() {
            addStudentModal.classList.add('hidden');
            addStudentModal.classList.remove('flex');
            addStudentForm.reset();
        }

        cancelAddBtn.addEventListener('click', closeModal);
        addStudentModal.addEventListener('click', (e) => {
            if (e.target === addStudentModal) closeModal();
        });

        addStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-student-name').value;
            const id = document.getElementById('new-student-id').value;
            const uid = document.getElementById('new-card-uid').value;

            try {
                // Use student ID as document ID
                await setDoc(doc(db, "students", id), {
                    Name: name,
                    cardUid: uid,
                    status: 'out' // Default status
                });
                closeModal();
                alert('Student added successfully!');
            } catch (error) {
                console.error("Error adding student:", error);
                alert('Failed to add student. See console for details.');
            }
        });

    </script>
</body>

</html>